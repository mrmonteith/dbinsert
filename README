### dbinsert

A small PHP utility that centralizes database inserts and logging using an OOP **trait** to reduce duplicate code. Designed to accept an associative array of column => value pairs, build an `INSERT` statement, execute it via PDO (ODBC driver in the example), and append a log entry for each operation.

---

### Contents
- **`example.php`** — simple usage example that builds a `$cars` array and calls the insert function.  
- **`dbinsert.class.php`** — thin class that `use`s the `DBInsertTrait`.  
- **`dbinsert.trait.php`** — core trait that builds the query, executes it, sets session messages, and writes logs.  
- **`config.php`** — project configuration (database credentials and settings).  
- **`logs/`** — directory where per-operation log files are written.

---

### Quick start

1. **Install / place files** in your project folder:
   - `dbinsert.trait.php`
   - `dbinsert.class.php`
   - `config.php` (see example below)
   - your script that calls the class (e.g., `example.php`)

2. **Example `config.php`** (adjust to your environment):
```php
<?php
// config.php - example
$servername = 'MY_DB_SERVER';
$dbname     = 'MY_DATABASE';
$username   = 'db_user';
$password   = 'db_password';
```

3. **Example usage** (save as `example.php`):
```php
<?php
require_once "config.php";
require_once 'dbinsert.class.php';

$cars = [
  'Car1' => 'Mustang',
  'Car2' => 'Ecosport'
];

$instance = new DBInsertClass();
$Name     = 'cars_print';   // log filename prefix
$Table    = 'test';         // target table name

$result = $instance->DBInsertFunction($Name, $cars, $Table);
echo $result;
```

4. **Run** the script in a web server or CLI environment that has access to the configured database and write permissions for the `logs/` folder.

---

### How it works (summary)

- The trait **accepts three parameters**: `$name` (used for log filename), `$data` (associative array of column => value), and `$table` (target table).
- It **builds column names and values** from the array and constructs an `INSERT` SQL string.
- The example uses **PDO with an ODBC driver** to execute the query.
- Results and errors are written to a per-name log file under the web root `logs/` directory.
- Session messages are set to indicate success or failure for UI feedback.

---

### Important notes & recommended improvements

- **Security (critical):** The current implementation concatenates values directly into the SQL string. This is vulnerable to SQL injection. Replace the string-building approach with **parameterized prepared statements** (bind values) before using in production.
- **Empty data checks:** Validate that `$data` is non-empty and that keys/values are valid before building the query.
- **Type handling:** Consider explicit type binding for integers, dates, and nulls.
- **Transactions:** Wrap multi-row or multi-table operations in transactions to ensure atomicity.
- **Error handling:** Capture and log exceptions more robustly; avoid echoing raw database errors to users.
- **Config loading:** Use `require_once` for `config.php` in the calling script and pass configuration into the class or trait rather than requiring it inside the trait. This improves testability and separation of concerns.
- **Logging path:** Avoid relying on `$_SERVER['DOCUMENT_ROOT']` for logs in CLI contexts; make the log path configurable.
- **Unit tests:** Extract query-building logic into a testable method and add unit tests to validate SQL generation and edge cases.
- **Session usage:** Ensure `session_start()` is called before setting `$_SESSION` values if you rely on session messages.

---

### Troubleshooting

- **`vendor` / PDO driver missing:** Ensure the required PDO/ODBC driver is installed and enabled in PHP.  
- **Permissions:** Ensure the web server or CLI user can write to the `logs/` directory.  
- **Null/empty `$data`:** If `$data` is empty, the trait will produce invalid SQL — add validation to avoid this.  
- **Unexpected errors:** Check the log file named `{name}.log` in the `logs/` folder for the raw query and any captured PDO error messages.

---

### Example improvements (snippet)

Replace naive query building with a parameterized approach:
```php
// build placeholders and bindings
$columns = array_keys($data);
$placeholders = array_map(fn($c) => ':' . $c, $columns);
$sql = sprintf(
  "INSERT INTO %s.%s (%s) VALUES (%s)",
  $servername,
  $table,
  implode(', ', $columns),
  implode(', ', $placeholders)
);

$stmt = $pdo->prepare($sql);
foreach ($data as $col => $val) {
  $stmt->bindValue(':' . $col, $val);
}
$stmt->execute();
```

---

### License

This project is available under the **MIT License**. Add a `LICENSE` file with the standard MIT text and update the copyright line.

---

### Contact / Author
**Michael Monteith** — created 2024-04-15.
